---
import SiteLayout from '@/layouts/SiteLayout.astro';
import { getCloudflareEnv } from '@/lib/env';
import { createDb } from '@/lib/db/client';
import { getLatestGlucose, getLatestInsulin, getRecentActivity, getLatestRun } from '@/lib/db/queries';

let glucose: { value: number; trend: string | null; timestamp: string } | null = null;
let insulin: { units: number; type: string; timestamp: string } | null = null;
let activity: { activeCalories: number | null; exerciseMinutes: number | null } | null = null;
let latestRun: { distanceKm: number | null; activityName: string | null; startTime: string } | null = null;

try {
  const cfEnv = await getCloudflareEnv();
  if (cfEnv) {
    const db = createDb(cfEnv.DB);
    const [g, i, a, r] = await Promise.all([
      getLatestGlucose(db),
      getLatestInsulin(db),
      getRecentActivity(db, 1),
      getLatestRun(db),
    ]);
    if (g) glucose = { value: g.value, trend: g.trend, timestamp: g.timestamp };
    if (i) insulin = { units: i.units, type: i.type, timestamp: i.timestamp };
    if (a[0]) activity = { activeCalories: a[0].activeCalories, exerciseMinutes: a[0].exerciseMinutes };
    if (r) latestRun = { distanceKm: r.distanceKm, activityName: r.activityName, startTime: r.startTime };
  }
} catch {
  // D1 unavailable in dev, graceful fallback
}

const TREND_ARROWS: Record<string, string> = {
  constant: '→', slowRise: '↗', slowFall: '↘', rise: '↑', fall: '↓',
  rapidRise: '⇈', rapidFall: '⇊', flat: '→', fortyFiveUp: '↗',
  fortyFiveDown: '↘', singleUp: '↑', singleDown: '↓', doubleUp: '⇈', doubleDown: '⇊',
};

function glucoseColor(value: number): string {
  if (value < 3.9) return 'text-glucose-low';
  if (value <= 10.0) return 'text-glucose-normal';
  if (value <= 13.9) return 'text-glucose-high';
  return 'text-glucose-very-high';
}

function timeAgo(timestamp: string): string {
  const diff = Date.now() - new Date(timestamp).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.floor(mins / 60);
  return `${hours}h ${mins % 60}m ago`;
}
---

<SiteLayout title="Dashboard | Coulton Fraser" activePath="/dashboard">
  <h1 class="text-xl font-semibold text-heading mb-6">Dashboard</h1>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Glucose card -->
    <a href="/dashboard/glucose" class="bg-tile border border-stroke rounded-lg p-5 no-underline hover:border-accent transition-colors group">
      <div class="text-xs font-medium text-dim uppercase tracking-wide mb-3">Current Glucose</div>
      {glucose ? (
        <>
          <div class="flex items-baseline gap-1.5">
            <span class={`text-[2rem] font-semibold leading-none ${glucoseColor(glucose.value)}`}>
              {glucose.value.toFixed(1)}
            </span>
            {glucose.trend && (
              <span class={`text-xl ${glucoseColor(glucose.value)}`}>
                {TREND_ARROWS[glucose.trend] ?? ''}
              </span>
            )}
          </div>
          <div class="text-[0.8rem] text-dim mb-3">mmol/L</div>
          <div class="text-xs text-ghost pt-3 border-t border-stroke">
            {timeAgo(glucose.timestamp)} · <span class="text-accent group-hover:underline">View details →</span>
          </div>
        </>
      ) : (
        <>
          <div class="text-[2rem] font-semibold text-heading leading-none mb-1">&mdash;</div>
          <div class="text-[0.8rem] text-dim mb-3">mmol/L</div>
          <div class="text-xs text-ghost pt-3 border-t border-stroke">
            No data yet · <span class="text-accent group-hover:underline">View details →</span>
          </div>
        </>
      )}
    </a>

    <!-- Insulin card -->
    <a href="/dashboard/insulin" class="bg-tile border border-stroke rounded-lg p-5 no-underline hover:border-accent transition-colors group">
      <div class="text-xs font-medium text-dim uppercase tracking-wide mb-3">Latest Bolus</div>
      {insulin ? (
        <>
          <div class="flex items-baseline gap-1.5">
            <span class="text-[2rem] font-semibold leading-none text-heading">
              {insulin.units.toFixed(1)}
            </span>
          </div>
          <div class="text-[0.8rem] text-dim mb-3">units</div>
          <div class="text-xs text-ghost pt-3 border-t border-stroke">
            {timeAgo(insulin.timestamp)} · <span class="text-accent group-hover:underline">View details →</span>
          </div>
        </>
      ) : (
        <>
          <div class="text-[2rem] font-semibold text-heading leading-none mb-1">&mdash;</div>
          <div class="text-[0.8rem] text-dim mb-3">units</div>
          <div class="text-xs text-ghost pt-3 border-t border-stroke">
            No data yet · <span class="text-accent group-hover:underline">View details →</span>
          </div>
        </>
      )}
    </a>

    <!-- Activity card -->
    <a href="/dashboard/activity" class="bg-tile border border-stroke rounded-lg p-5 no-underline hover:border-accent transition-colors group">
      <div class="text-xs font-medium text-dim uppercase tracking-wide mb-3">Today&rsquo;s Activity</div>
      {activity && (activity.exerciseMinutes || activity.activeCalories) ? (
        <>
          <div class="flex items-baseline gap-1.5">
            <span class="text-[2rem] font-semibold leading-none text-heading">
              {activity.exerciseMinutes ?? 0}
            </span>
            <span class="text-sm text-dim">min</span>
            {activity.activeCalories ? (
              <span class="text-sm text-dim ml-2">{activity.activeCalories} kcal</span>
            ) : null}
          </div>
          <div class="text-[0.8rem] text-dim mb-3">exercise</div>
          <div class="text-xs text-ghost pt-3 border-t border-stroke">
            {latestRun ? `Last: ${latestRun.activityName ?? 'Workout'}` : 'Today'} · <span class="text-accent group-hover:underline">View details →</span>
          </div>
        </>
      ) : (
        <>
          <div class="text-[2rem] font-semibold text-heading leading-none mb-1">&mdash;</div>
          <div class="text-[0.8rem] text-dim mb-3">exercise</div>
          <div class="text-xs text-ghost pt-3 border-t border-stroke">
            No data yet · <span class="text-accent group-hover:underline">View details →</span>
          </div>
        </>
      )}
    </a>
  </div>
</SiteLayout>
